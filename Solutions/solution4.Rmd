---
title: "Graphics with ggplot2 (solution)"
author: "Science Data Lab & Center for Health Data Science"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  #pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, eval = TRUE, warning = FALSE)
```
 
Loading the core tidyverse packages and the 'readxl' package for data import from .xlsx.

```{r}
library(tidyverse)
library(readxl)
```

Importing the climate data from **climate.xlsx**^[Contains public sector information licensed under the [Open Government Licence v3.0](http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/).]. (Change the path to the Excel file below so that it matches the path to the file saved on your own computer, or use *Import Dataset* in RStudio to obtain the relevant code.)

```{r}
# point to the file so I can knit

my_path<-gsub("/Solutions.*","",getwd())
#Get a path to data folder
#path <- "Exercises/data/"

climate <- read_excel(paste0(my_path,"/FromExcelToR/Exercises/data/climate.xlsx"))
climate
```

### Scatter plot I

**Solutions 1, 2, 3, 4**

```{r scatter_plot_i}
p <- ggplot(climate, aes(x = sun, y = rain, colour = station)) + 
  geom_point() +
  facet_wrap(~station) +
  theme(legend.position = "none")

p
```

### Scatter plot II: labels

**5**

```{r}
p + geom_text(aes(label = month))
```

**6**

```{r}
p + geom_text(aes(label = month), nudge_y = 15)
```

**7**

```{r}
p + geom_label(aes(label = month), nudge_y = 15)
```

### Graphic files

**7 check working directory**

```{r}
#getwd()
```


**8,9** 

```{r}
ggsave(file="weather.jpeg")

ggsave(file="weather.png",width=10,height=8,units="cm")
```

### Scatter plot III: error bars

**10** 

```{r}
summary_stats <- climate %>%
  group_by(month) %>% 
  summarize(sun_avg = mean(sun), sun_sd = sd(sun))

summary_stats
```

**11**

```{r}

p <- ggplot(summary_stats, aes(x = month, y = sun_avg)) +
  geom_point()

p
```

**12**

```{r}
p + geom_errorbar(aes(ymin = sun_avg - sun_sd, ymax = sun_avg + sun_sd), width = 0.2)

```

**13**

Month cannot have an error since it's categorical, so we need to flip the plot. 

```{r}
p + coord_flip()
```

### Line plot

**14**

You need the `group` aesthetic to group together the data points to be connected by lines.

```{r}
ggplot(climate, aes(x = month, y = rain, group = station, colour = station)) +
  geom_line()
```

We get a continuous x axis.

**15**

But `month` should be categorical. We don't have a data point for 7.5 months. 

```{r}
climate <- mutate(climate, month = factor(month))

ggplot(climate, aes(x = month, y = rain, group = station, colour = station)) +
  geom_line()
```

Now the x-axis is discrete. 

**16**

```{r}
ggplot(climate, aes(x = month, y = rain, group = station, colour = station)) +
  geom_line() +
  theme(legend.position = "top")
```

### Layering

**17** 

```{r}
ggplot(climate, aes(x = month, y = rain, group = station, colour = station)) +
  geom_line() +
  geom_point()
```

**18**

```{r}
ggplot(climate, aes(x = month, y = rain, group = station, colour = station)) +
  geom_line() +
  geom_point() +
  theme(legend.position = "top") +
  geom_hline(yintercept = mean(climate$rain), linetype = "dashed")
```

We have added a line that shows the average level of rainfall across all stations. Now we can see whenever stations are above or below the general average.

**19**

```{r}
climate <- mutate(climate, month = factor(month))

ggplot(climate, aes(x = month, y = rain, group = station, colour = station)) +
  geom_line() +
  geom_point() +
  theme(legend.position = "top") +
  geom_hline(yintercept = mean(climate$rain), linetype = "dashed") +
  labs(x = "Month", y = "Rainfall (mm)", colour = "Weather station")
```

### Box plot I

**Solutions 22, 23** 

```{r}
ggplot(climate, aes(x = station, y = sun)) +
  geom_boxplot(aes(fill = station))
```

The `fill` aesthetic could also be inside the `ggplot` call.

### Box plot II - Aesthetics

*24** 

```{r}
ggplot(climate, aes(x=station, y=sun, fill=station)) +
  geom_boxplot() +
  labs(fill = "Custom Title")
```

**25**

Try all the themes:

```{r}
#example
ggplot(climate, aes(x=station, y=sun, fill=station)) +
  geom_boxplot() +
  labs(fill = "Custom Title") +
  theme_minimal()
```

**26**

```{r}
ggplot(climate, aes(x=station, y=sun, fill=station)) + 
  geom_boxplot() + 
  labs(fill = "Custom Title") + 
  theme_minimal() +
  scale_fill_manual(values = c("darkcyan","steelblue", "lightblue", "lavender", "pink"))
```

**27**

violin plot:

```{r}
ggplot(climate, aes(x=station, y=sun, fill=station)) + 
  geom_violin() + 
  labs(fill = "Custom Title") + 
  theme_minimal() +
  scale_fill_manual(values = c("darkcyan","steelblue", "lightblue", "lavender", "pink"))
```

Plus scatter of the actual observations (`jitter`):


```{r}
ggplot(climate, aes(x=station, y=sun, fill=station)) + 
  geom_violin() + 
  geom_jitter(size = 1, alpha = 0.7, width = 0.2) +
  labs(fill = "Custom Title") + 
  theme_minimal() +
  scale_fill_manual(values = c("darkcyan","steelblue", "lightblue", "lavender", "pink"))
```

Add small boxplots inside. So cute!


```{r}
ggplot(climate, aes(x=station, y=sun, fill=station)) + 
  geom_violin(trim=FALSE) + 
  geom_jitter(size = 1, alpha = 0.7, width = 0.2) +
  geom_boxplot(width=.1) + 
  scale_fill_manual(values = c("darkcyan","steelblue", "lightblue", "lavender", "pink")) + 
  labs(fill = "Custom Title") + 
  theme(legend.position="top") +
  theme_minimal() 
```

### Histogram

**28**

```{r}
ggplot(climate, aes(x = rain)) +
  geom_histogram()
```


**29**

Change width of histogram bins:

```{r}
ggplot(climate, aes(x = rain)) +
  geom_histogram(binwidth = 25)
```


**30**

Add colors. These arguments are outside the `aes` so they affect the entire plot! 

```{r}
ggplot(climate, aes(x = rain)) +
  geom_histogram(binwidth = 25, colour = "red", fill = "orange")
```

### Bar chart I

**32**

Month is already a factor from question 15. 

```{r}
ggplot(climate, aes(x = month, y = sun)) +
  geom_col()
```

**33**

```{r}
ggplot(climate, aes(x = month, y = sun, fill = station)) +
  geom_col()
```

**34**

Side by side with `dodge`

```{r}
ggplot(climate, aes(x = month, y = sun, fill = station)) +
  geom_col(position = 'dodge')
```

**35** 

```{r}
ggplot(climate, aes(x = month, y = sun, fill = station)) +
  geom_col(position = 'dodge') +
  labs(x = "Month", y = "Sunshine (hours)", colour = "Weather station")
```

### Bar chart II

**39**

First, we need to calculate the annual rainfall. Annual means we sum the rainfall over the entire year, and we do this per station:

```{r}
annual_rain <- 
  climate %>%
  group_by(station) %>% 
  summarize(sum_rain = sum(rain))

annual_rain
  
```

```{r}
ggplot(annual_rain, aes(x = station, y = sum_rain)) +
  geom_col()
```


**40**

Add sorting the factor levels of station after the sum of the rainfall so they will be ordered

```{r}
#sort the df after the rainfall column
annual_rain <- annual_rain %>% arrange(sum_rain)

#add sorting the factor levels of station after the rainfall so they will be ordered
annual_rain <- annual_rain %>%
  mutate(station = factor(station, levels = annual_rain$station)) 


```

**41**

Add labels that state the exact number in the bar. 

```{r}
ggplot(annual_rain, aes(x = station, y = sum_rain)) +
  geom_col() +
  geom_text(aes(label = sum_rain))
```

**42**

Adjust label position

```{r}
ggplot(annual_rain, aes(x = station, y = sum_rain)) +
  geom_col() +
  geom_text(aes(label = sum_rain), nudge_y =  60)
```

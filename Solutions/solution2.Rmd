---
title: "II\\. Working with data in R (solution)"
author: "Science Data Lab & Center for Health Data Science"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  #pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, eval = TRUE, warning = FALSE)
```

Loading the core **tidyverse** packages, as well as the **readxl** package for importing data from .xlsx

```{r}
library(tidyverse)
library(readxl)
```

### Importing data

1-2. Use the '`read_excel` function from package `readxl` to import that data: 

```{r}
library(readxl)
# point to the file if it's not in your current working directory
full_path <- '~/Documents/Heads_center_management/courses/excel_to_r/oct2022/FromExceltoR/Exercises/data/'
climate <- read_excel(paste0(full_path,"climate.xlsx"))
climate
```

3.a) How many observations are there?

```{r}
dim(climate)
```

3.b) How many data columns are there and what are their types?

```{r}
summary(climate)
```

3.c) How many different stations are there?

```{r}
distinct(climate,station)
```

3.d) How many observations per station?

```{r}
count(climate,station)
```


### Working with the data

```{r}
library(tidyverse)
```

Select from the climate dataset:

4.a) all rows from the station in Oxford

```{r}
climate %>%
  filter(station == 'oxford')
```

4.b) all rows from the station in Oxford when there were at least 100 hours of sunlight

```{r}
climate %>%
  filter(station == 'oxford' & sun >= 100)
```


4.c) all rows from the stations in Oxford and Camborne when there were at least 100 hours of sunlight 

```{r}
climate %>%
  filter(station %in% c('oxford','camborne') & sun >= 100)
```

4.d) a subset that only contains the station, year and rain columns

```{r}
sub <- climate %>%
  select(station, year, rain)
sub
```

5. Compute the average rainfall over the full dataset by using the `summarize` function.

```{r}
climate %>%
  summarize(avg_rain = mean(rain))
```

6. Calculate average rainfall, the standard deviation of the monthly rainfall as well as the total rainfall nad put them in the same table. 

```{r}
rain_stats <- climate %>%
  summarize(avg_rain = mean(rain),
          sd_rain = sd(rain),
          sum_rain = sum(rain))
```

7. Summary statistics for rainfall data grouped by weather station.

```{r}
climate %>%
  group_by(station) %>% 
  summarize(avg_rain = mean(rain),
            sd_rain = sd(rain),
            sum_rain = sum(rain))
```

8. Including number of observations for each station.

```{r}
climate %>%
  group_by(station) %>% 
  summarize(avg_rain = mean(rain),
            sd_rain = sd(rain),
            sum_rain = sum(rain),
            n=n())
```
    
9. Sorted in descending order according to annual rainfall.    
 
```{r}
climate %>%
  group_by(station) %>% 
  summarize(avg_rain = mean(rain),
            sd_rain = sd(rain),
            sum_rain = sum(rain),
            n=n()) %>% 
  arrange(desc(sum_rain))
```


### Manipulating the data



10. Create a new copy of the climate dataset to which you have added a column that states the amount of hours with no sunshine for each month. A month has on average 730 hours, you can use the same amount of hours for all of them to calculate the new column.

```{r}
climate_plus <- climate %>%
  mutate(no_sun = 730 - sun)
```

11. Add another column to your new dataset that says whether the weather this month was good. We consider a month to be good if it had at least 50 hours of sunlight and less than 100 mm of rain. Otherwise the weather was bad.

```{r}
climate_plus <- climate_plus %>%
  mutate(good_weather = ifelse(sun > 100 & rain < 100, "Yes", "No"))
climate_plus
```

12. Count the number of months per station that did not have any days with air frost.

```{r}
climate %>%
  count(station, af == 0)
```


13. Count the number of months with good weather per station (use the column you made in 10). Whatâ€™s the place with the best weather in England?


```{r}
climate_plus %>%
  filter(good_weather == 'Yes') %>%
  count(station) %>%
  arrange(n)
```

Oxford has the most months with good weather (9).

### Complex operations

The final questions require that you combine commands and variables of the type above.

14. Identify the weather station for which the median number of monthly sunshine hours over the months April to September was largest.


```{r}
climate %>% 
  filter(month %in% 4:9) %>% 
  group_by(station) %>% 
  summarize(med_sun = median(sun)) %>% 
  arrange(desc(med_sun))
```

Weather station with largest median number of monthly sunshine hours over the months April to September was Oxford

15. For each weather station apart from the one in Armagh, compute the total rainfall and sunshine duration during the months with no days of air frost. Present the totals in centimetres and days, respectively.


```{r}
climate %>% 
  group_by(station) %>% 
  filter(station != "armagh", af == 0) %>% 
  summarize(total_rain = sum(rain)/10,
            total_sun = sum(sun)/24)
```


16. For each month, count how many stations recorded at least two days of air frost or more than 95 mm rain. Tip: Think about how you can do that with `filter` and `summarize`. Then, for these data lines compute the average number of sunshine hours split up by month.

   
```{r}
climate %>%
  filter(af >= 2 | rain > 95) %>% 
  group_by(month) %>% 
  summarize(count = n(), avg_sun = mean(sun))
```

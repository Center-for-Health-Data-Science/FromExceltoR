---
title: "II. Working with data in R (solution)"
author: "Science Data Lab & Center for Health Data Science"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, eval = TRUE, warning = FALSE)
```

Loading the core **tidyverse** packages, as well as the **readxl** package for importing data from .xlsx

```{r}
library(tidyverse)
library(readxl)
```

### Importing data

1-2. Use the '`read_excel` function from package `readxl` to import that data. My working directory is set to `Solutions` where this Rmarkdown is so I need to go one directory up.  

```{r}
library(readxl)
climate <- read_excel("../Exercises/data/climate.xlsx")
climate
```

3.a) How many observations are there?

```{r}
dim(climate)
```

3.b) What timeframe does each line represent?

Each line is one month.

3.c) How many data columns are there and what are their types?

```{r}
summary(climate)
```

3.d) How many different stations are there?

```{r}
distinct(climate,station)
```

3.e) How many observations per station?

```{r}
count(climate,station)
```


### Working with the data

```{r}
library(tidyverse)
```

4. Count the number of months per station that did not have any days with air frost.

```{r}
climate %>%
  count(station, af == 0)
```



Select from the climate dataset:

5.a) all rows from the station in Oxford

```{r}
climate %>%
  filter(station == 'oxford')
```

5.b) all rows from the station in Oxford when there were at least 100 hours of sunlight

```{r}
climate %>%
  filter(station == 'oxford' & sun >= 100)
```


5.c) all rows from the stations in Oxford and Camborne when there were at least 100 hours of sunlight 

```{r}
climate %>%
  filter(station %in% c('oxford','camborne') & sun >= 100)
```

5.d) a subset that only contains the station, year and rain columns

```{r}
sub <- climate %>%
  select(station, year, rain)
sub
```

6. Compute the average rainfall over the full dataset by using the `summarize` function.

```{r}
climate %>%
  summarize(avg_rain = mean(rain))
```

7. Calculate average rainfall, the standard deviation of the monthly rainfall as well as the total rainfall and put them in the same table. 

```{r}
rain_stats <- climate %>%
  summarize(avg_rain = mean(rain),
          sd_rain = sd(rain),
          sum_rain = sum(rain))
```

8. Summary statistics for rainfall data grouped by weather station.

```{r}
climate %>%
  group_by(station) %>% 
  summarize(avg_rain = mean(rain),
            sd_rain = sd(rain),
            sum_rain = sum(rain))
```

9. Including number of observations for each station.

```{r}
climate %>%
  group_by(station) %>% 
  summarize(avg_rain = mean(rain),
            sd_rain = sd(rain),
            sum_rain = sum(rain),
            n=n())
```
    
10. Sorted in descending order according to annual rainfall.    
 
```{r}
climate %>%
  group_by(station) %>% 
  summarize(avg_rain = mean(rain),
            sd_rain = sd(rain),
            sum_rain = sum(rain),
            n=n()) %>% 
  arrange(desc(sum_rain))
```


### Manipulating the data



11. Create a new column in `climate` with the number of days in each month that had no air frost (complementing the `af` column).

```{r}
climate_plus <- climate %>%
  mutate(no_af = 30 - af)
```

12. Add another column to your new dataset that says whether the weather this month was good. We consider a month to be good if it had at least 100 hours of sunlight and less than 100 mm of rain. Otherwise the weather was bad.

```{r}
climate_plus <- climate_plus %>%
  mutate(good_weather = ifelse(sun > 100 & rain < 100, "Yes", "No"))
climate_plus
```

13. How many months are there with good weather (use the column you made in 12) for each station? Find the station that has the most months with good weather.

```{r}
climate_plus %>%
  filter(good_weather == 'Yes') %>%
  group_by(station) %>%
  count %>%
  arrange(desc(n))
```

This also works:

```{r}
climate_plus %>%
  filter(good_weather == 'Yes') %>%
  count(station) %>%
  arrange(n)
```

Oxford has the most months with good weather (9).

### Bonus questions: Complex operations

The final questions require that you combine commands and variables of the type above.

14. For each weather station apart from the one in Armagh, compute the total rainfall and sunshine duration during the months with no days of air frost. Present the totals in centimetres and days, respectively.


```{r}
climate %>% 
  group_by(station) %>% 
  filter(station != "armagh", af == 0) %>% 
  summarize(total_rain = sum(rain)/10,
            total_sun = sum(sun)/24)
```


15. Identify the weather station for which the median number of monthly sunshine hours over the months April to September was largest.


```{r}
climate %>% 
  filter(month %in% 4:9) %>% 
  group_by(station) %>% 
  summarize(med_sun = median(sun)) %>% 
  arrange(desc(med_sun))
```

The weather station with largest median number of monthly sunshine hours over the months April to September was Oxford.

---
title: "VI. Bioinformatics in R (presentation)"
author: "Center for Health Data Science, University of Copenhagen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  #pdf_document: default
  html_document: default
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Bioconductor

[Bioconductor](https://www.bioconductor.org/) provides tools for computational biology and bioinformatics analysis in R - it is open source and open development and it has an active user community.   
Mostly when we install R-packages we use `install.packages('name_of_package')`. When we use this command we refer to the [CRAN repository](https://cran.r-project.org/) of packages, however sometimes we want a package from `Bioconductor` instead. For this we use the command `BiocManager::install('name_of_package')`. In order to use this installer, you need to download the R-package `BiocManager` e.g. `install.packages('BiocManager')`.  



## Gene Expression Analysis in R with `DEseq2`

[DEseq2](https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html) is one of the many packages/frameworks which exists for analysis of bulk gene expression data in R. For more information on DEseq2, please have a look at the original publication [here](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-014-0550-8).   

Other highly used packages for differential expression analysis _DEA_ are:   

* [limma](https://bioconductor.org/packages/release/bioc/vignettes/limma/inst/doc/usersguide.pdf)   

* [edgeR](https://bioconductor.org/packages/release/bioc/vignettes/edgeR/inst/doc/edgeRUsersGuide.pdf)   

* [NOIseq](https://www.bioconductor.org/packages/release/bioc/vignettes/NOISeq/inst/doc/NOISeq.pdf)   

`DEseq2` has many advantages over classical models and post hoc tests, as it is specifically developed for handling common issues and biases in expression data, including differences in sequencing depth and highly variable dispersion of counts between genes.   
In brief, `DEseq2` fits a generalized linear model (GLM) for each gene in the dataset. In the case where we compare two groups i.e. treatment vs control, the GLM fit returns coefficients indicating the overall expression strength of a gene, along with the log2 fold change between groups. `DEseq2` adjusts variable gene dispersion estimates using an empirical Bayes approach which borrows information across genes and shrinks gene-wise dispersions towards a common dispersion trend to increase accuracy of differential expression testing.

&nbsp;

---


### About the Dataset

The dataset used for this presentation was acquired from the following github tutorial on RNAseq analysis: <https://combine-australia.github.io/RNAseq-R/06-rnaseq-day1.html>.

RNA sequencing data generated from luminal and basal cell sub-populations in the mammary gland of three groups of mice:   
- Control   
- Pregnant   
- Lactating

The objective of the original study (found [here](https://pubmed.ncbi.nlm.nih.gov/25730472/)) was to identify genes specifically expressed in lactating mammary glands, the gene expression profiles of luminal and basal cells from different developmental stages were compared.

&nbsp;

---

### Load R-packages:

```{r}
# Data Wrangling
# install.packages("tidyverse")
# install.packages("readxl")
library(tidyverse)
library(readxl)

# For Plotting
# install.packages("ggplot2")
library(ggplot2)


# For DEA
# install.packages("BiocManager")
# BiocManager::install("DESeq2")
library(DESeq2)
```


&nbsp;

---

### Importing Data

Reading in data:
```{r}
exprDat <- read_excel("MouseRNAseq.xlsx")
exprInfo <- read_excel("MouseSampleInfo.xlsx")

# Look at the data:
head(exprDat, n=5)
dim(exprDat)

head(exprInfo)
```
Convert character columns to factor types:
```{r}
exprInfo <- exprInfo %>%
  mutate(CellType = as.factor(CellType),
         Status = as.factor(Status))

head(exprInfo)
```


&nbsp;

---

### Initial Data Check & Filtering:

Let's try to sample 16 (n) random genes and plot their count distribution.

```{r}
# Sample 16 random rows
expr16 <- exprDat %>%
  sample_n(.,16)

# Extract genenames
GeneName <- expr16$GeneName

# Gather counts
expr16 <- expr16 %>%
  dplyr::select(-GeneName) %>%
  t() %>% 
  as_tibble() %>% 
  rename_at(vars(names(.)), ~GeneName) %>% 
  gather()

# Give it a look:
expr16
```

Plot:
```{r}
ggplot(expr16, aes(log2(value+1))) + 
  geom_histogram(color="black", fill="grey80", bins=20) + 
  theme_minimal() +
  facet_wrap(~key)
```

---

We will filter out genes with too many zero counts. We will exclude the columns with gene information:

```{r}
# Count number of 0s across samples. Filter samples where at least four samples has a count great than 0.

exprDat <- exprDat %>% 
  mutate(nzeros = rowSums(dplyr::select(.,-GeneName)==0)) %>%
  filter(nzeros <= 8) %>%
  dplyr::select(-nzeros)

# How many genes do we have left:
dim(exprDat)
```

&nbsp;

---

## Differential Expression Analysis- DESeq2


We will now make a DESeq2 object. For this we use the function `DESeqDataSetFromMatrix` from the DEseq2 package. As input we give our count matrix, our gene IDs and our meta data (exprInfo). Additionally we include a design for DE contrasts. In this case we add CellType (luminal or basal) and Status (control, pregnant or lactating).   


Convert to exprDat to a dataframe and make GeneNames column into rownames:
```{r}
# Pull out GeneNames and EntrezGeneID for later use
GeneNames <- exprDat %>%
  dplyr::select(GeneName)

  
exprDat <- exprDat %>%
  column_to_rownames(., var = "GeneName")
```


Make a DESeq2 object:
```{r}
exprObj <- DESeqDataSetFromMatrix(countData = exprDat,
                              colData = exprInfo,
                              design= ~CellType+Status)
exprObj
```

---


### Principal Component Analysis

Before performing DEA it is a good idea to explore how samples cluster together based on there gene expression profile. The expectation here is that samples from the same group (treatment vs control, condition A vs condition B, etc.) will cluster together. A principal component analysis (PCA) plot can also help us to identify outlier samples which might need to be removed from the analysis. We use our vst counts for principal component analysis:

```{r}
plotPCA(exprObjvst,intgroup="Status")
plotPCA(exprObjvst,intgroup="CellType")
```

&nbsp;

---

### DESeq function for DEA

Next, we use `DEseq()` to estimate dispersion, gene-wise and mean-dispersion, fitting model(s):
```{r}
exprObj <- DESeq(exprObj)
```

---

### Testing

Have a look at the group comparisons: 

```{r}
resultsNames(exprObj)
```

&nbsp;

---

Test for DE genes between the three groups of mice, adjusted for cell type:   

(I) lactating and control mice:
```{r}
resLC <- results(exprObj, contrast = c("Status", "lactate", "control"), independentFiltering = FALSE)
```

Summary and plot of DE analysis results:

```{r}
DESeq2::plotMA(resLC)
summary(resLC)
```
Below we perform the same steps as above to get the DE genes between (II) pregnant and control mice and (III) lactating and pregnant mice:   

   
(II) pregnant and control mice:
```{r}
resPC <- results(exprObj, contrast = c("Status", "pregnant", "control"),  independentFiltering = FALSE)

#DESeq2::plotMA(resPC)
#summary(resPC)
```

   
   
(III) lactating and pregnant mice:
```{r}
resLP <- results(exprObj, contrast = c("Status", "lactate", "pregnant"),  independentFiltering = FALSE)

#DESeq2::plotMA(resLP)
#summary(resLP)
```

&nbsp;

---

We filter the results of the DEA to only include those genes which are differentially expressed based on logFC (>= 1.0 or <= -1.0) and adjusted p-value (< 0.01).   
Firstly, bind the three DE genesets together and convert to a tibble. Then, add a column with GeneNames. Lastly, filter and arrange rows (genes) based on logFC and adjusted p-values.

```{r}
resDE <- rbind(resLC, resPC, resLP) %>% 
  as_tibble() %>%
  mutate(GeneName = rep(GeneNames$GeneName, 3)) %>%
  filter((log2FoldChange >= 1.0 | log2FoldChange <= -1.0) & padj <= 0.01) %>%
  arrange(padj, desc(abs(log2FoldChange)))

# DE genes 
dim(resDE)
length(unique(resDE$GeneName))
```
   
---


&nbsp;

---

### Heatmap Visualization

To visually inspect if DE genes identified in our DESeq2 analysis successfully separate the three groups of mice (control, pregnant and lactating), we will make a heatmap. 
For this we use the `heatmap` function.

It will not make sense to include all DE genes in this heatmap (almost 3000 unique genes). Instead pick the top 100 most significant DE genes, based on adj. p-value and logFC.

---

Make a vector of unique GeneNames (top100):
```{r}
# Make a vector of unique EntrezGeneIDs (top100):

top100 <- resDE[1:100,] %>%
  pull(GeneName) %>%
  unique()

length(top100)
```

---

The expression counts themselves (not logFC) are needed for the heatmap. We use the topDE vector to extract these from the vst normalized DESeq2 object.

```{r}
head(assay(exprObjvst), n=5)

resVST <- assay(exprObjvst) %>% 
  as.data.frame() %>%
  rownames_to_column(var = "GeneName")  %>%
  as_tibble() %>%
  filter(GeneName %in% top100)
```


The heatmap function in base R wants gene expression data as a matrix (a dataframe with numeric values only). We extract the GeneNames column and convert the tibble into a matrix:
```{r}
HPnames <- resVST %>% 
  pull(GeneName)


HPdat <- resVST %>%
  dplyr::select(-GeneName) %>%
  as.matrix()
```


---

We use the `heatmap` function to generate a heatmap. We can modify the look of the heatmap as desired, e.g. add column colors, row labels, change color scheme etc.

```{r}
heatmap(HPdat,
        ColSideColors=exprInfo$CellType.colors, 
        labCol=exprInfo$Status,
        labRow = HPnames,
        cexCol=1.2, 
        cexRow = 1.0)
```



